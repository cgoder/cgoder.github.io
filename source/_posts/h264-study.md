---
title: h264 study
date: 2017-05-27 10:55:26
tags:
---

# H264标准学习笔记

## 0. 基础
H264结构中，一个视频图像编码后的数据叫做一帧，一帧由一个片（slice）或多个片组成，一个片由一个或多个宏块（MB）组成，一个宏块由16x16的yuv数据组成。宏块作为H264编码的基本单位。


 
- H264编码过程中的三种不同的数据形式：
    + **SODB**: String Of Data Bits. 数据比特串 ---> 最原始的编码数据，即VCL数据。
    + **RBSP**: Raw Byte Sequence Payload. 原始字节序列载荷 ---> 在SODB的后面填加了结尾比特（RBSP trailing bits一个bit“1”）若干比特“0”,以便字节对齐。
    + **EBSP**: 扩展字节序列载荷 ---> 在RBSP基础上填加了仿校验字节（0X03）。  
 


- **VCL**: video coding layer. 视频编码层。
核心算法引擎，块，宏块及片的语法级别的定义。
VCL设计目标：尽可能地独立于网络的情况下进行高效的编解码。

- **NAL**: network abstraction layer. 网络提取层。
片级以上的语法级别（如序列参数集和图像参数集），同时支持以下功能：独立片解码，起始码唯一保证，SEI以及流格式编码数据传送。
NAL设计目标：根据不同的网络把数据打包成相应的格式，将VCL产生的比特字符串适配到各种各样的网络和多元环境中。  


## 1. 流
- 首先要理解的是没有标准的H.264基本流格式。文档中的确包含了一个Annex，特别是描述了一种可能的格式Annex B格式，但是这个并不是一个必须要求的格式。标准文档中指定了视频怎样编码成独立的包，但是这些包是怎样存储和传输的却是开放的。  



 

 

### 1.1 **Annex B**字节流格式
Annex B格式给每个NALU加上前缀码：2个或者3个0x00,后面再加一个0x01, 如：0x000001或者0x00000001。 即每个帧的开头的3~4个字节是H264的start_code,0x00000001或者0x000001。  
Annex B格式通常用于实时的流格式，比如说传输流，通过无线传输的广播、DVD等。在这些格式中通常会周期性的重复SPS和PPS包，经常是在每一个关键帧之前，因此据此建立解码器可以一个随机访问的点，这样就可以加入一个正在进行的流，及播放一个已经在传输的流。  

 

### 1.2 **AVCC**格式
AVCC格式中，每一个NALU包都加上了一个指定其长度(NALU包大小)的前缀(in big endian format大端格式)，这种格式的包非常容易解析，但是这种格式去掉了Annex B格式中的字节对齐特性，而且前缀可以是1、2或4字节，这让AVCC格式变得更复杂了，指定前缀字节数(1、2或4字节)的值保存在一个头部对象中(流开始的部分)，这个头通常称为'extradata'或者'sequence header'。    
AVCC格式的一个优点是在开始配置解码器的时候可以跳到流的中间播放，这种格式通常用于可以被随机访问的多媒体数据，如存储在硬盘的文件。
也因为这个特性，MP4、MKV通常用AVCC格式来存储。


## 2. NAL/NALU
- 视频编码成的包叫做Network Abstraction Layer Units, 也简称为**NALU、NAL**，每个NALU包都可以被单独的解析和处理，每个NALU包的第一个字节包含了NALU类型，bit3-bit7包含的内容尤其重要(bit 0一定是off的，bit1-2指定了这个NALU是否被其他NALU引用)。  
> *一个单独的NALU包、或者甚至一个VCL NALU包都不意味着是一个独立的帧，一帧数据可以被分割成几个NALU，一个或多个NALU组成了一个Access Units(AU)，AU包含了一个完整的帧。把帧分割成几个独立的NALU需要耗费许多CPU资源，所以分割帧数据并不经常使用。*

### 2.1 NALU Header: NALU头结构
- forbidden_zero_bit(1bit): 禁止位。
    通常应该设置为0。当网络发现NAL单元有比特错误时可设置该比特为1，以便接收方丢掉该单元。
- nal_ref_idc(2bit): 重要性指示位。
    用于表示当前NALU的重要性，值越大，越重要。解码器在解码处理不过来的时候，可以丢掉重要性为0的NALU。  
    **NAL_5/NAL_7/NAL_8时，nal_ref_idc不能为0；NAL_6/NAL_9/NAL_10/NAL_11/NAL_12时，nal_ref_idc应该为0。**
    + DIR的I帧是非常重要的，他一丢，那么这个序列的所有帧都没办法解码了；
    + 没有序列参数集，这个序列的帧就没法解；
    + 没有图像参数集，那用到这个图像参数集的帧都没法解。
    | nal_unit_type | nal_unit_type (value) | nal_ref_idc |
    | :-: | :-: | :-: |
    | 0 | 未使用 (none) | 0 |
    | 1 | 非IDR帧的slice (2/3/4) | 若slice属于参考帧，不为0；否则为0 |
    | 2 | slice数据A block (2) | 同上 |
    | 3 | slice数据B bloc (3) | 同上 |
    | 4 | slice数据C bloc (4) | 同上 |
    | 5 | IDR帧的slice (2/3) | 5 |
    | 6 | 补充增强信息单元SEI (5) | 0 |
    | 7 | 序列参数集SPS (0) | 非0 |
    | 8 | 图像参数集PPS (1) | 非0 |
    | 9| 分界符 (6) | 0 |    
    | 10 | 序列结束 (7) | 0 |    
    | 11 | 码流结束 (8) | 0 |    
    | 12 | 填充 (9) | 0 |    
    | 13...23 | 保留 (none) | 0 |    
    | 24...31 | 自定义 (none) | 0 |    

- nal_unit_type(5bit): NALU类型。
    总共有32种类型。其中，0未定义，1～12由H.264使用，24～31由H.264以外的应用使用。
    标识NAL单元中的RBSP数据类型，其中，nal_unit_type为1/2/3/4/5的NAL单元称为**VCL**的NAL单元，其他类型的NAL单元为**Non-VCL**的NAL单元。


- 参数集：包括序列参数集SPS(NAL_7) / 图像参数集PPS(NAL_8)
    + **SPS**: 包含的是针对一连续编码视频序列的参数，如标识符 seq_parameter_set_id、帧数及 POC 的约束、参考帧数目、解码图像尺寸和帧场编码模式选择标识等等。作用于一串连续的视频图像，即视频序列。两个IDR图像之间为序列参数集。
    + **PPS**: 对应的是一个序列中某一幅图像或者某几幅图像，其参数如标识符 pic_parameter_set_id、可选的 seq_parameter_set_id、熵编码模式选择标识、片组数目、初始量化参数和去方块滤波系数调整标识等等。作用于视频序列中的一个或多个个别的图像序列和图像参数集机制，减少了重复参数的传送，每个VCL NAL单元包含一个标识，指向有关的图像参数集，每个图像参数集包含一个标识，指向有关的序列参数集的内容因此，只用少数的指针信息，引用大量的参数，大大减少每个VCL NAL单元重复传送的信息。
> SPS和PPS可以在发送VCL NAL单元以前发送，并且重复传送，大大提高纠错能力。序列和图像参数集可以在“带内”，也可以用更为可靠的其他“带外”通道传送。  

- 数据分割：组成片的编码数据存放在 3 个独立的 DP（数据分割，A、B、C）中，各自包含一个编码片的子集。
    + 分割A包含片头和片中每个宏块头数据。
    + 分割B包含帧内和 SI 片宏块的编码残差数据。
    + 分割C包含帧间宏块的编码残差数据。
    + 每个分割可放在独立的NAL单元并独立传输。

- 存储单元：
一组指定格式的NAL单元称为存储单元，每个存储单元对应一个图像。每个存储单元包含一组VCL NAL单元，组成一个主编码图像，VCL NAL单元由表示视频图像采样的像条所组成。存储单元前面可以加一个前缀，分界存储单元，附加增强信息（SEI）（如图像定时信息）也可以放在主编码图像的前面。主编码图像后附加的VCL NAL单元，包含同一图像的冗余表示，称为冗余编码图像，当主编码图像数据丢失或损坏时，可用冗余编码图像解码。
 
- 编码视频序列:
一个编码视频序列由一串连续的存储单元组成，使用同一序列参数集。每个视频序列可独立解码。编码序列的开始是即时刷新存储单元（IDR）。IDR是一个I帧图像，表示后面的图像不用参考以前的图像。一个NAL单元流可包含一个或更多的编码视频序列。
 
- I帧和IDR帧的区别：
    + 在 H.264 中 I 帧并不具有随机访问的能力，这个功能由 IDR 承担。以前的标准中由 I 帧承担。
    + IDR帧会导致 DPB 参考帧列表清空（*这是关键所在*），而I帧不会。
    + I和IDR帧其实都是I帧,都是使用帧内预测的。但是IDR帧的作用是立刻刷新,使错误不致传播,从IDR帧开始,重新算一个新的序列开始编码。
    + IDR帧一定是I帧，但I帧不一定是IDR帧。一个序列中可以有很多的I帧，I帧之后的帧可以引用I帧之间的帧做运动参考。

#### 2.1.1 nal_unit_type: NALU类型 
NALU总共有32种类型。其中，NAL_0未定义，NAL_1～NAL_12由H.264使用，NAL_24～NAL_31由H.264以外的应用使用。
- NALU格式分为2类，`VCL`和`non-VCL`。  
    + VCL: Video Coding Layer packets contain the actual visual information.  即视频编码后的数据。NAL_1 ~ NAL_5。
    + Non-VCL: contain metadata that may or may not be required to decode the video.  非视频数据，配置信息。NAL_0/NAL_6 ~ NAL_31.
> NAL_0：未规定 (non-VCL)
NAL_1：非IDR图像中不采用数据划分的片段（P帧） (VCL)
NAL_2：非IDR图像中A类数据划分片段 (VCL)
NAL_3：非IDR图像中B类数据划分片段 (VCL)
NAL_4：非IDR图像中C类数据划分片段 (VCL)
**NAL_5：IDR图像的片段**（IDR帧）(VCL)
**NAL_6：补充增强信息（SEI）** (non-VCL)
**NAL_7：序列参数集（SPS）** (non-VCL)
**NAL_8：图像参数集（PPS）** (non-VCL)
**NAL_9：分割符** (non-VCL)
NAL_10：序列结束符 (non-VCL)
NAL_11：流结束符 (non-VCL)
NAL_12：填充数据 (non-VCL)
NAL_13：序列参数集扩展 (non-VCL)
NAL_14：带前缀的NAL单元 (non-VCL)
NAL_15：子序列参数集 (non-VCL)
NAL_16 ~ 18：保留 (non-VCL)
NAL_19：不采用数据划分的辅助编码图像片段 (non-VCL)
NAL_20：编码片段扩展 (non-VCL)
NAL_21 ~ 23：保留 (non-VCL)
NAL_24 ~ 31：未规定 (non-VCL)

### 2.2 NALU StartCode: NALU起始码
一个NALU包中的数据并不包含它的大小(长度)信息,因此不能简单的连接NALU包来建立一个流，因为你不知道一个包从哪里结束，另一个包从哪里开始。由于NAL是依次紧密相连的，解码器就无法在数据流中分辨出每个NAL的起始位置和终止位置。  

Annex B格式用开始码来解决这个问题。  
即给每个NALU加上前缀码：2个或者3个0x00,后面再加一个0x01, 如：0x000001或者0x00000001。  
> 4字节类型的开始码在在连续的数据传输中非常有用，因为用字节来对齐、分割流数据，比如：用连续的31个bit0后接一个bit1来分割流数据，是很容易的。如果接下来的bit是0(因为每个NALU都以bit0开始)，那么这就是一个NALU包数据的起始位置了。4字节类型的开始码通常只用于标识流中的随机访问点，如SPS PPS AUD和IDR，然后其他地方都用3字节类型的开始码以减少数据量。  

**我们必须考虑当NAL内部出现了0x000001和0x000000的情况。**
如果NALU对应的Slice为一帧的开始，则用4字节表示，即0x00000001；否则用3字节表示，0x000001。 
为了防止NAL内部出现0x000001的数据，H264又提出**防止竞争(Emulation Prevention Bytes)机制**。

### 2.3  EPB防止竞争机制
在编码完一个NAL时，如果检测出有连续两个0x00字节，就在后面插入一个0x03，则在NAL数据内肯定不会存在NAL起始码0x000001。
> 0x000000  >>>>>>  0x00000300(结束码)
> 0x000001 >>>>>>  0x00000301(起始码)
> 0x000002 >>>>>>  0x00000302(保留)
> 0x000003 >>>>>>  0x00000303(保证解码器正常工作)

**所以，在NAL单元中，下面的三字节序列不应在任何字节对齐的位置出现。**
> 0X000000
> 0X000001
> 0X000002

开始码能起作用是因为3字节的序列0x000000,0x000001,0x000002和0x000003(应该是所有的0x0000**)在non-VCL NALU包中是非法的，所以在构建ANLU包时，必须确保排除这些数值序列，这是由向每个这种类型的序列插入防竞争字节0x03实现的。那么插入防竞争字节后，0x000001变成了0x00000301。  
因为防竞争字节可能出现在NALU包的任意位置，查找和去除防竞争字节非常重要。当解码器在NAL内部检测到0x000003的数据，就把0x03抛弃，恢复原始数据。  

### 2.4 NALU的顺序要求
 H.264/AVC标准对送到解码器的NAL单元顺序是有严格要求的，如果NAL单元的顺序是混乱的，必须将其重新依照规范组织后送入解码器，否则解码器不能够正确解码。

1. 序列参数集NAL单元，必须在传送所有以此参数集为参考的其他NAL单元之前传送，不过允许这些NAL单元中间出现重复的序列参数集NAL单元。
所谓重复的详细解释为：序列参数集NAL单元都有其专门的标识，如果两个序列参数集NAL单元的标识相同，就可以认为后一个只不过是前一个的拷贝，而非新的序列参数集。
2. 图像参数集NAL单元，必须在所有以此参数集为参考的其他NAL单元之前传送，不过允许这些NAL单元中间出现重复的图像参数集NAL单元，这一点与上述的序列参数集NAL单元是相同的。     
3. 不同基本编码图像中的片段（slice）单元和数据划分片段（data partition）单元在顺序上不可以相互交叉，即不允许属于某一基本编码图像的一系列片段（slice）单元和数据划分片段（data partition）单元中忽然出现另一个基本编码图像的片段（slice）单元片段和数据划分片段（data partition）单元。
4. 参考图像的影响：如果一幅图像以另一幅图像为参考，则属于前者的所有片段（slice）单元和数据划分片段（data partition）单元必须在属于后者的片段和数据划分片段之后，无论是基本编码图像还是冗余编码图像都必须遵守这个规则。
5. 基本编码图像的所有片段（slice）单元和数据划分片段（data partition）单元必须在属于相应冗余编码图像的片段（slice）单元和数据划分片段（data partition）单元之前。  
6. 如果数据流中出现了连续的无参考基本编码图像，则图像序号小的在前面。      
7. 如果arbitrary_slice_order_allowed_flag置为1，一个基本编码图像中的片段（slice）单元和数据划分片段（data partition）单元的顺序是任意的，如果arbitrary_slice_order_allowed_flag置为零，则要按照片段中第一个宏块的位置来确定片段的顺序，若使用数据划分，则A类数据划分片段在B类数据划分片段之前，B类数据划分片段在C类数据划分片段之前，而且对应不同片段的数据划分片段不能相互交叉，也不能与没有数据划分的片段相互交叉。
8. 如果存在SEI（补充增强信息）单元的话，它必须在它所对应的基本编码图像的片段（slice）单元和数据划分片段（data partition）单元之前，并同时必须紧接在上一个基本编码图像的所有片段（slice）单元和数据划分片段（data partition）单元后边。假如SEI属于多个基本编码图像，其顺序仅以第一个基本编码图像为参照。
9. 如果存在图像分割符的话，它必须在所有SEI 单元、基本编码图像的所有片段slice）单元和数据划分片段（data partition）单元之前，并且紧接着上一个基本编码图像那些NAL单元。       
10. 如果存在序列结束符，且序列结束符后还有图像，则该图像必须是IDR（即时解码器刷新）图像。序列结束符的位置应当在属于这个IDR图像的分割符、SEI 单元等数据之前，且紧接着前面那些图像的NAL单元。如果序列结束符后没有图像了，那么它的就在比特流中所有图像数据之后。
11. 流结束符在比特流中的最后。

## 参考文献
[http://m.blog.csdn.net/article/details?id=13810671](http://m.blog.csdn.net/article/details?id=13810671)
[http://www.cnblogs.com/TaigaCon/p/5215448.html](http://www.cnblogs.com/TaigaCon/p/5215448.html)
[https://erwinchang.github.io/2017/03/14/h264/](https://erwinchang.github.io/2017/03/14/h264/)
[http://www.jianshu.com/p/9522c4a7818d](http://www.jianshu.com/p/9522c4a7818d)
[http://www.samirchen.com/video-concept/](http://www.samirchen.com/video-concept/)


